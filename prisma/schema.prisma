generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id            String    @id @default(cuid())
  name          String?
  username      String?   @unique
  displayName   String?   // Display name for forum
  email         String    @unique
  emailVerified DateTime?
  image         String?
  role          Int       @default(1) // 1 = demo, 2 = full, 9 = admin
  apiKey        String?   @unique
  apiKeyCreatedAt DateTime?
  installationId String?   // Bound device/installation ID
  installationBoundAt DateTime?

  // Subscription fields
  subscriptionStatus SubscriptionStatus @default(INACTIVE)
  subscriptionEndDate DateTime?
  subscriptionType   SubscriptionType?

  // Affiliate fields
  referralCode      String?   @unique // User's unique referral code
  referredById      String?   // Who referred this user
  affiliateBalance  Int       @default(0) // Balance in cents (unpaid commissions)
  totalEarnings     Int       @default(0) // Total lifetime earnings in cents

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  accounts      Account[]
  sessions      Session[]
  referredBy    User?     @relation("Referrals", fields: [referredById], references: [id])
  referrals     User[]    @relation("Referrals")
  payments      Payment[]
  commissionsEarned Commission[] @relation("AffiliateCommissions")
  commissionsPaid   Commission[] @relation("UserCommissions")
  programSelections UserProgramSelection[]
  uploadedStats     UserUploadedStats[]

  @@index([referralCode])
  @@index([referredById])
  @@index([subscriptionStatus])
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// ===================================
// Program Templates (for Electron app)
// ===================================

enum AuthType {
  API_KEY      // Only API key/token needed
  CREDENTIALS  // Username + password needed
  BOTH         // Either API key OR credentials work
}

model ProgramTemplate {
  id           String   @id @default(cuid())
  name         String   @unique // e.g., "7BitPartners", "CellXpert"
  softwareType String   // e.g., "7bitpartners", "cellxpert", "income-access"
  authType     AuthType @default(CREDENTIALS)
  baseUrl      String?  // Default base URL if applicable
  loginUrl     String?  // Default login URL if applicable
  description  String?  // Help text for users
  icon         String?  // Emoji or icon name
  displayOrder Int      @default(0)
  isActive     Boolean  @default(true)
  referralUrl  String?  // Affiliate signup link for this program

  // Field labels (customize what users see)
  apiKeyLabel    String?  // e.g., "Statistic Token", "API Key"
  usernameLabel  String?  // e.g., "Username", "Email", "Partner ID"
  passwordLabel  String?  // e.g., "Password", "API Secret"
  baseUrlLabel   String?  // e.g., "Affiliate URL", "Dashboard URL"

  // Field requirements
  requiresBaseUrl Boolean @default(false)

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  statsDronePrograms StatsDrone_Program[]
  userSelections     UserProgramSelection[]

  @@index([softwareType])
  @@index([isActive])
  @@index([displayOrder])
}

// ===================================
// Forum System
// ===================================

model ForumCategory {
  id           String   @id @default(cuid())
  name         String
  slug         String   @unique
  description  String?
  icon         String?  // emoji or icon name
  displayOrder Int      @default(0)
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  topics ForumTopic[]

  @@index([slug])
  @@index([displayOrder])
  @@index([isActive])
}

model ForumTopic {
  id              String    @id @default(cuid())
  categoryId      String
  authorId        String
  title           String
  slug            String    @unique
  isPinned        Boolean   @default(false)
  isLocked        Boolean   @default(false)
  viewCount       Int       @default(0)
  replyCount      Int       @default(0)
  lastReplyAt     DateTime?
  lastReplyUserId String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  category  ForumCategory        @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  posts     ForumPost[]
  followers ForumTopicFollower[]

  @@index([categoryId])
  @@index([authorId])
  @@index([slug])
  @@index([isPinned])
  @@index([lastReplyAt])
}

model ForumPost {
  id        String    @id @default(cuid())
  topicId   String
  authorId  String
  content   String    @db.Text
  isEdited  Boolean   @default(false)
  editedAt  DateTime?
  editedBy  String?
  isDeleted Boolean   @default(false)
  deletedAt DateTime?
  deletedBy String?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  topic       ForumTopic        @relation(fields: [topicId], references: [id], onDelete: Cascade)
  attachments ForumAttachment[]

  @@index([topicId])
  @@index([authorId])
  @@index([createdAt])
  @@index([isDeleted])
}

model ForumAttachment {
  id        String   @id @default(cuid())
  postId    String
  url       String   // Blob URL
  filename  String
  mimeType  String
  size      Int      // bytes
  width     Int?     // for images
  height    Int?     // for images
  createdAt DateTime @default(now())

  post ForumPost @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@index([postId])
}

model ForumPrivateMessage {
  id        String   @id @default(cuid())
  senderId  String
  subject   String
  content   String   @db.Text
  createdAt DateTime @default(now())

  participants ForumMessageParticipant[]

  @@index([senderId])
  @@index([createdAt])
}

model ForumMessageParticipant {
  id        String    @id @default(cuid())
  messageId String
  userId    String
  isRead    Boolean   @default(false)
  readAt    DateTime?
  isDeleted Boolean   @default(false)
  deletedAt DateTime?

  message ForumPrivateMessage @relation(fields: [messageId], references: [id], onDelete: Cascade)

  @@unique([messageId, userId])
  @@index([userId])
  @@index([messageId])
  @@index([isRead])
  @@index([isDeleted])
}

model ForumTopicFollower {
  id                 String   @id @default(cuid())
  topicId            String
  userId             String
  emailNotifications Boolean  @default(true)
  unsubscribeToken   String   @unique @default(cuid())
  createdAt          DateTime @default(now())

  topic ForumTopic @relation(fields: [topicId], references: [id], onDelete: Cascade)

  @@unique([topicId, userId])
  @@index([userId])
  @@index([topicId])
  @@index([unsubscribeToken])
}

// ===================================
// Notification System
// ===================================

enum NotificationType {
  FORUM_REPLY
  FORUM_MENTION
  FORUM_MESSAGE
  SYSTEM
  ANNOUNCEMENT
}

model Notification {
  id        String           @id @default(cuid())
  userId    String
  type      NotificationType
  title     String
  message   String
  link      String?          // URL to navigate to when clicked
  icon      String?          // Optional emoji or icon name
  isRead    Boolean          @default(false)
  metadata  Json?            // Additional data
  createdAt DateTime         @default(now())

  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
  @@index([userId, isRead])
}

// ===================================
// Subscription & Payment System
// ===================================

enum SubscriptionStatus {
  ACTIVE     // Paid and active
  INACTIVE   // Not subscribed (demo mode - 5 programs max)
  TRIAL      // Trial period
  CANCELLED  // Cancelled but still active until end date
  EXPIRED    // Subscription ended
}

enum SubscriptionType {
  CRYPTO         // Manual crypto payment
  PAYPAL_MONTHLY // PayPal monthly subscription
  PAYPAL_YEARLY  // PayPal yearly subscription
}

enum PaymentStatus {
  PENDING    // Waiting for confirmation
  COMPLETED  // Payment confirmed
  FAILED     // Payment failed
  REFUNDED   // Payment refunded
}

model Payment {
  id              String         @id @default(cuid())
  userId          String
  amount          Int            // Amount in cents
  currency        String         @default("USD")
  status          PaymentStatus  @default(PENDING)
  type            SubscriptionType
  months          Int            @default(1) // Number of months added
  paypalOrderId   String?        // PayPal order ID if applicable
  paypalSubscriptionId String?   // PayPal subscription ID if applicable
  cryptoTxHash    String?        // Crypto transaction hash if applicable
  cryptoAddress   String?        // Crypto address used
  notes           String?        // Admin notes
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  completedAt     DateTime?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  commissions Commission[]

  @@index([userId])
  @@index([status])
  @@index([paypalOrderId])
  @@index([paypalSubscriptionId])
  @@index([createdAt])
}

// ===================================
// Affiliate System
// ===================================

model Commission {
  id           String   @id @default(cuid())
  affiliateId  String   // User who earns the commission
  userId       String   // User who made the purchase
  paymentId    String   // The payment that triggered this
  amount       Int      // Commission amount in cents
  rate         Float    // Commission rate at time of transaction (e.g., 0.15 for 15%)
  tier         Int      @default(1) // Referral tier (1 = direct referral)
  isPaid       Boolean  @default(false)
  paidAt       DateTime?
  createdAt    DateTime @default(now())

  affiliate User    @relation("AffiliateCommissions", fields: [affiliateId], references: [id], onDelete: Cascade)
  user      User    @relation("UserCommissions", fields: [userId], references: [id], onDelete: Cascade)
  payment   Payment @relation(fields: [paymentId], references: [id], onDelete: Cascade)

  @@index([affiliateId])
  @@index([userId])
  @@index([paymentId])
  @@index([isPaid])
  @@index([createdAt])
}

model AffiliateSettings {
  id                  String   @id @default(cuid())
  tier1CommissionRate Float    @default(0.15) // 15% default
  tier2CommissionRate Float?   // Optional second tier
  minPayoutAmount     Int      @default(5000) // Minimum payout in cents ($50)
  cookieDurationDays  Int      @default(30)   // How long referral cookie lasts
  isActive            Boolean  @default(true)
  updatedAt           DateTime @updatedAt
}

model SubscriptionPricing {
  id          String   @id @default(cuid())
  name        String   // "Monthly", "Yearly"
  type        SubscriptionType
  price       Int      // Price in cents
  months      Int      // Number of months included
  isActive    Boolean  @default(true)
  paypalPlanId String? // PayPal subscription plan ID
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([type])
  @@index([isActive])
}

// StatsDrone scraped data - separate tables for imported programs
model StatsDrone_Program {
  id                String   @id @default(cuid())
  name              String
  slug              String   @unique
  software          String?
  commission        String?
  apiSupport        Boolean  @default(false)
  availableInSD     Boolean  @default(false)
  category          String?
  logoUrl           String?
  reviewUrl         String?
  joinUrl           String?  // StatsDrone redirect URL
  finalJoinUrl      String?  // Resolved affiliate URL (cleaned)
  exclusiveOffer    String?
  sourceUrl         String   // Original StatsDrone URL
  scrapedAt         DateTime @default(now())
  lastCheckedAt     DateTime @default(now())
  isActive          Boolean  @default(true)

  // Status tracking
  status            String   @default("pending") // pending, signed_up, added_as_template, closed

  // Signup credentials (generated per program)
  signupPassword    String?  // Auto-generated password for this program
  signupUsername    String?  // Username used for signup (if different from profile)
  signupEmail       String?  // Email used for signup (if different from profile)
  signupDate        DateTime? // When we signed up

  // Mapped to our system
  mappedToTemplate  Boolean  @default(false)
  templateId        String?
  template          ProgramTemplate? @relation(fields: [templateId], references: [id], onDelete: SetNull)

  @@index([software])
  @@index([category])
  @@index([apiSupport])
  @@index([mappedToTemplate])
  @@index([scrapedAt])
  @@index([status])
}

model StatsDrone_ScrapingLog {
  id          String   @id @default(cuid())
  software    String?  // Which software filter was being scraped
  page        Int?
  status      String   // "running", "success", "error", "partial"
  programsFound Int    @default(0)
  currentProgress String? // e.g., "Processing program 50/2100"
  error       String?
  startedAt   DateTime @default(now())
  completedAt DateTime?

  @@index([software])
  @@index([status])
  @@index([startedAt])
}

// Universal signup profile for affiliate program registrations
// User's selected programs for their stats client
model UserProgramSelection {
  id          String   @id @default(cuid())
  userId      String
  programId   String   // ProgramTemplate ID
  selectedAt  DateTime @default(now())

  user    User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  program ProgramTemplate @relation(fields: [programId], references: [id], onDelete: Cascade)

  @@unique([userId, programId])
  @@index([userId])
  @@index([programId])
  @@index([selectedAt])
}

// User's uploaded stats from the Electron client
// No credentials - just anonymous aggregate stats per program
model UserUploadedStats {
  id          String   @id @default(cuid())
  userId      String
  programName String   // Program name from the client
  programCode String   // Program code (unique identifier)
  month       String   // YYYY-MM format

  // Stats data (stored as cents where applicable)
  clicks      Int      @default(0)
  impressions Int      @default(0)
  signups     Int      @default(0)
  ftds        Int      @default(0)
  deposits    Int      @default(0)  // in cents
  revenue     Int      @default(0)  // in cents
  currency    String   @default("USD")

  uploadedAt  DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, programCode, month])
  @@index([userId])
  @@index([month])
  @@index([uploadedAt])
}

model SignupProfile {
  id          String   @id @default(cuid())
  name        String   @default("Default") // Profile name (e.g., "Main", "Business", "Personal")
  isDefault   Boolean  @default(false)

  // Personal Info
  firstName   String?
  lastName    String?
  email       String?
  phone       String?

  // Company Info
  companyName String?
  website     String?

  // Address
  address     String?
  city        String?
  state       String?
  country     String   @default("US")
  zipCode     String?

  // Account Credentials (use same across signups or vary per program)
  username    String?
  password    String?  // Note: Consider encryption for production

  // Messaging
  skype       String?
  telegram    String?
  discord     String?

  // Marketing
  trafficSources    String?  // e.g., "SEO, PPC, Social Media"
  monthlyVisitors   String?  // e.g., "10,000-50,000"
  promotionMethods  String?  // e.g., "Website, Email Marketing"

  // Additional
  comments    String?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}
